{% extends 'base.html' %}

{% block title %}Loan Repayment{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Loan Repayment</h2>

    <div class="card">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}

                <!-- Repayment Date -->
                <div class="row">
                    <div class="col-md-6">
                        <label>Repayment Date:</label>
                        <input type="date" name="repayment_date" class="form-control" required>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Member Name:</label>
                        <input type="text" class="form-control" value="{{ member.name }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Member ID:</label>
                        <input type="text" class="form-control" value="{{ member.member_id }}" disabled>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Outstanding Loan Balance:</label>
                        <input type="text" id="loan_balance" class="form-control" value="{{ member.max_loan_amount }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Monthly Interest (0.9583% of Balance):</label>
                        <input type="text" id="interest_amount" class="form-control" value="{{ interest_amount }}" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Principal Paid:</label>
                        <input type="number" id="principal_paid" name="principal_paid" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>Total Payment (Interest + Principal):</label>
                        <input type="text" id="total_payment" class="form-control" readonly>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Repayment Number:</label>
                        <input type="text" class="form-control" value="{{ repayment_number }}" disabled>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-success">Submit Payment</button>
                    <a href="{% url 'loan' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let loanBalance = parseFloat(document.getElementById("loan_balance").value) || 0;
        let interestAmountField = document.getElementById("interest_amount");
        let principalPaidField = document.getElementById("principal_paid");
        let totalPaymentField = document.getElementById("total_payment");

        // Function to calculate interest and total payment
        function calculateInterestAndTotal() {
            let interestAmount = (loanBalance * 0.009583).toFixed(2);  // 0.9583% interest based on the opening balance
            interestAmountField.value = interestAmount;

            let principalPaid = parseFloat(principalPaidField.value) || 0;
            let totalPayment = (parseFloat(interestAmount) + principalPaid).toFixed(2);
            totalPaymentField.value = totalPayment;
        }

        // Event listener for recalculating total payment when principal is changed
        principalPaidField.addEventListener("input", calculateInterestAndTotal);

        calculateInterestAndTotal(); // Initial calculation
    });
</script>

{% endblock %}
