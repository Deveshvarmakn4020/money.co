{% extends 'base.html' %}

{% block title %}Loan Repayment{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Loan Repayment</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-body">
            <form method="POST" id="repaymentForm">
                {% csrf_token %}

                <!-- ✅ NEW: Member Selection Dropdown -->
                <div class="row">
                    <div class="col-md-6">
                        <label>Select Member (Optional):</label>
                        <select name="selected_member" class="form-control">
                            <option value="">-- Use Current Member --</option>
                            {% for m in all_members %}
                                <option value="{{ m.id }}">
                                    {{ m.name }} ({{ m.member_id }})
                                </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">
                            If selected, repayment will be stored for chosen member.
                        </small>
                    </div>
                </div>

                <!-- Repayment Date -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Repayment Date:</label>
                        <input type="date" name="repayment_date"
                               class="form-control" required id="repaymentDate">
                    </div>
                </div>

                <!-- Member Info -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Member Name:</label>
                        <input type="text" class="form-control"
                               value="{{ member.name }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Member ID:</label>
                        <input type="text" class="form-control"
                               value="{{ member.member_id }}" disabled>
                    </div>
                </div>

                <!-- Loan & Interest -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Outstanding Loan Balance (₹):</label>
                        <input type="text" id="loan_balance"
                               class="form-control"
                               value="{{ member.max_loan_amount }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label>Monthly Interest (0.9583%) (₹):</label>
                        <input type="text" id="interest_amount"
                               class="form-control"
                               value="{{ interest_amount }}" readonly>
                    </div>
                </div>

                <!-- Payment Inputs -->
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label>Principal Paid (₹):</label>
                        <input type="number" id="principal_paid"
                               name="principal_paid"
                               class="form-control"
                               min="0.01"
                               max="{{ member.max_loan_amount }}"
                               step="0.01" required>
                    </div>

                    <div class="col-md-4">
                        <label>RD Deposited (₹):</label>
                        <input type="number" id="rd_amount"
                               name="rd_amount"
                               class="form-control"
                               min="0" step="0.01" value="0">
                    </div>

                    <div class="col-md-4">
                        <label>Total Payment (Interest + Principal + RD) (₹):</label>
                        <input type="text" id="total_payment"
                               class="form-control" readonly>
                    </div>
                </div>

                <!-- Repayment Number -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Repayment Number:</label>
                        <input type="text" class="form-control"
                               value="{{ repayment_number }}" disabled>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-success">
                        Submit Payment
                    </button>
                    <a href="{% url 'loan' %}" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    const loanBalance = parseFloat("{{ member.max_loan_amount }}") || 0;

    const interestAmountField = document.getElementById("interest_amount");
    const principalPaidField = document.getElementById("principal_paid");
    const rdAmountField = document.getElementById("rd_amount");
    const totalPaymentField = document.getElementById("total_payment");
    const repaymentDateField = document.getElementById("repaymentDate");

    // Default date = today
    repaymentDateField.value = new Date().toISOString().split('T')[0];

    function calculatePayment() {
        const interestAmount = (loanBalance * 0.009583).toFixed(2);
        interestAmountField.value = interestAmount;

        const principalPaid = parseFloat(principalPaidField.value) || 0;
        const rdAmount = parseFloat(rdAmountField.value) || 0;

        const totalPayment =
            parseFloat(interestAmount) + principalPaid + rdAmount;

        totalPaymentField.value = totalPayment.toFixed(2);
    }

    principalPaidField.addEventListener("input", function () {
        if (parseFloat(this.value) > loanBalance) {
            this.value = loanBalance.toFixed(2);
        }
        calculatePayment();
    });

    rdAmountField.addEventListener("input", calculatePayment);

    calculatePayment();
});
</script>

{% endblock %}
